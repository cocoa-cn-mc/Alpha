<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>プラグイン管理 - α鯖</title>
  <link rel="icon" href="../img/favicon.png" type="image/png">
  <style>
    :root{
      --accent:#2b8a3e;
      --muted:#6b7280;
      --bg:#f6f8fa;
      --card:#fff;
      --maxw:1200px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter","Noto Sans JP",sans-serif;background:var(--bg);color:#111}
    header{background:linear-gradient(180deg,#0b1220,#0f172a);color:#fff;padding:20px;text-align:center}
    main{max-width:var(--maxw);margin:18px auto;padding:18px}
    .section{margin-bottom:18px}
    .panel{background:var(--card);padding:14px;border-radius:10px;border:1px solid #e6eef6}
    label{display:block;font-weight:700;margin-top:8px}
    input[type="text"], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef6;margin-top:6px}
    .actions{display:flex;gap:8px;margin-top:10px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #e6eef6}
    .btn.warn{background:#d9534f;color:#fff}
    .small{font-size:0.9rem;color:var(--muted);margin-top:8px}

    .add-area{display:grid;grid-template-columns:1fr 420px;gap:12px;align-items:start}
    .add-main{padding:12px}
    .add-side{padding:12px}

    .controls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
    .search{display:flex;gap:8px;align-items:center}
    .search input{padding:8px;border-radius:8px;border:1px solid #e6eef6}
    .plugins-grid{display:flex;flex-direction:column;gap:12px}
    .plugin-card{background:var(--card);border-radius:12px;padding:14px;border:1px solid #e6eef6;display:flex;gap:12px;align-items:flex-start}
    .plugin-thumb{width:120px;height:120px;border-radius:10px;object-fit:cover;flex:0 0 120px;background:#f1f5f9;position:relative}
    .plugin-main{flex:1}
    .plugin-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .plugin-title{font-size:1.1rem;margin:0}
    .plugin-meta{color:var(--muted);font-size:0.95rem}
    .plugin-body{margin-top:8px;display:flex;gap:12px}
    .cmd-list{flex:1}
    .cmd-item{background:#fafafa;border-radius:8px;padding:8px;margin-bottom:8px;border:1px solid #eef2f6}
    .cmd-row{display:flex;gap:8px;align-items:flex-start}
    .cmd-row input[type="text"]{flex:0 0 260px}
    .cmd-row textarea{flex:1;min-height:56px}
    .cmd-actions{display:flex;gap:6px;align-items:center;margin-left:auto}
    .uploader{display:flex;gap:8px;align-items:center;margin-top:8px;flex-direction:column}
    .thumbs{display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:320px;overflow:auto;padding-right:6px}
    .thumb-item{display:flex;gap:8px;align-items:center;background:#fff;border-radius:8px;padding:6px;border:1px solid #eef2f6;position:relative}
    .thumb-item img{width:72px;height:72px;object-fit:cover;border-radius:6px}
    .thumb-meta{flex:1;display:flex;flex-direction:column;gap:6px}
    .thumb-actions{display:flex;gap:6px;align-items:center}
    .note{font-size:0.9rem;color:var(--muted);margin-top:8px}
    .pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px}
    .page-btn{padding:6px 10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;cursor:pointer}

    /* 番号バッジ */
    .badge {
      position: absolute;
      top: 6px;
      left: 6px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      font-weight:700;
      padding:4px 8px;
      border-radius:999px;
      font-size:14px;
      line-height:1;
      z-index:2;
    }

    /* サムネ専用プレビュー */
    .thumb-preview{border-radius:8px;overflow:hidden;background:#fff;border:1px solid #eef2f6;padding:8px;margin-top:8px}
    .thumb-preview img{width:100%;height:auto;display:block}

    @media (max-width:980px){
      .add-area{grid-template-columns:1fr}
      .plugin-thumb{width:96px;height:96px}
    }
  </style>
</head>
<body>
  <header>
    <h1>プラグイン管理</h1>
    <p style="margin:6px 0 0;opacity:0.9">公開ページからはアクセスできない管理画面です。上で追加、下で既存編集を行います。</p>
  </header>

  <main>
    <!-- 上：プラグイン追加（大きく） -->
    <section class="section panel add-area" aria-label="プラグイン追加">
      <div class="add-main">
        <h2>プラグインを追加 / 編集</h2>

        <label for="pl-name">名前</label>
        <input id="pl-name" type="text" placeholder="例：ホーム（/home）">

        <label for="pl-category">カテゴリ</label>
        <select id="pl-category">
          <option value="player">一般プレイヤー用</option>
          <option value="admin">管理者用</option>
        </select>

        <label for="pl-desc">短い説明（一覧用）</label>
        <input id="pl-desc" type="text" placeholder="一覧に表示する短い説明">

        <label for="pl-long-desc">詳細説明（公開ページでの詳細）</label>
        <textarea id="pl-long-desc" rows="8" placeholder="プラグインの詳細な説明や注意点。ここで改行した内容は公開ページでも改行されます。"></textarea>

        <label>コマンド（個別に追加）</label>
        <div class="note">コマンドは「コマンド文字列」「説明」「権限」を個別に設定します。表示名は使いません。</div>

        <div class="actions" style="margin-top:12px">
          <button id="add-cmd" class="btn ghost" type="button">コマンドを追加</button>
          <button id="save-btn" class="btn" type="button">追加して保存</button>
          <button id="new-btn" class="btn ghost" type="button">フォームをクリア</button>
        </div>

        <div class="small">追加後、下の一覧で編集・削除できます。</div>
      </div>

      <aside class="add-side">
        <div class="panel">
          <h3>画像（複数）</h3>
          <div class="uploader">
            <input id="pl-images-file" type="file" accept="image/*" multiple>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="add-images-btn" class="btn ghost" type="button">画像を追加</button>
              <button id="clear-images-btn" class="btn ghost" type="button">全てクリア</button>
            </div>
            <div class="thumbs" id="thumbs" aria-live="polite"></div>

            <h4 style="margin-top:12px">サムネイル（個別）</h4>
            <div class="note">ここで選んだサムネが公開ページの一覧やカードのサムネとして使われます。既存の画像から選ぶか、別途アップロードできます。</div>

            <div style="display:flex;gap:8px;margin-top:8px">
              <select id="thumbnail-source" style="flex:1">
                <option value="">-- サムネを選択 --</option>
                <option value="from_images">既存画像から選ぶ</option>
                <option value="upload_new">新しくアップロード</option>
              </select>
              <input id="pl-thumbnail-file" type="file" accept="image/*" style="display:none">
            </div>

            <div id="thumbnail-list" style="margin-top:8px"></div>
            <div class="thumb-preview" id="thumbnail-preview" style="display:none"></div>

            <div class="note">サムネは images 配列とは独立して保存されます。外部URLを使う場合はインポートで設定できます。</div>
          </div>
        </div>
      </aside>
    </section>

    <!-- 下：既存プラグイン編集 -->
    <section class="section panel" aria-label="既存プラグイン編集">
      <div class="controls">
        <div class="search">
          <input id="search-input" type="text" placeholder="検索：名前・説明・コマンド">
          <select id="filter-cat">
            <option value="">すべてのカテゴリ</option>
            <option value="player">一般プレイヤー用</option>
            <option value="admin">管理者用</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="export-btn" class="btn ghost" type="button">エクスポート</button>
          <button id="import-btn" class="btn ghost" type="button">インポート</button>
          <input id="import-file" type="file" accept="application/json" style="display:none">
          <button id="clear-all-btn" class="btn warn" type="button">全てのプラグインを削除</button>
        </div>
      </div>

      <div id="plugins-grid" class="plugins-grid" aria-live="polite"></div>
      <div class="pager" id="pager" aria-hidden="true"></div>
    </section>
  </main>

  <script>
    (function(){
      const STORAGE_KEY = 'alpha_plugins_v1';
      const PAGE_SIZE = 6;

      // DOM（追加フォーム）
      const nameInput = document.getElementById('pl-name');
      const categoryInput = document.getElementById('pl-category');
      const descInput = document.getElementById('pl-desc');
      const longDescInput = document.getElementById('pl-long-desc');

      const imagesFileInput = document.getElementById('pl-images-file');
      const thumbsEl = document.getElementById('thumbs');
      const addImagesBtn = document.getElementById('add-images-btn');
      const clearImagesBtn = document.getElementById('clear-images-btn');

      const thumbnailSource = document.getElementById('thumbnail-source');
      const thumbnailFileInput = document.getElementById('pl-thumbnail-file');
      const thumbnailList = document.getElementById('thumbnail-list');
      const thumbnailPreview = document.getElementById('thumbnail-preview');

      const addCmdBtn = document.getElementById('add-cmd');
      const saveBtn = document.getElementById('save-btn');
      const newBtn = document.getElementById('new-btn');

      // DOM（一覧）
      const pluginsGrid = document.getElementById('plugins-grid');
      const searchInput = document.getElementById('search-input');
      const filterCat = document.getElementById('filter-cat');
      const pager = document.getElementById('pager');
      const importBtn = document.getElementById('import-btn');
      const exportBtn = document.getElementById('export-btn');
      const importFile = document.getElementById('import-file');
      const clearAllBtn = document.getElementById('clear-all-btn');

      // state
      let items = [];
      let editingId = null;
      let currentPage = 1;
      let imagesData = []; // array of dataURL strings for the add/edit form
      let thumbnailData = ''; // dataURL or URL for thumbnail (independent)

      // util
      function load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          items = raw ? JSON.parse(raw) : [];
        }catch(e){ items = []; }
      }
      function save(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        try{ window.dispatchEvent(new StorageEvent('storage', { key: STORAGE_KEY })); }catch(e){}
      }
      function uid(){ return 'pl-' + Date.now() + '-' + Math.floor(Math.random()*1000); }

      // image compression helper
      function imageFileToCompressedDataURL(file, maxWidth = 1200, quality = 0.75) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const reader = new FileReader();
          reader.onload = () => {
            img.onload = () => {
              try {
                const ratio = img.width / img.height || 1;
                let targetW = img.width;
                let targetH = img.height;
                if (img.width > maxWidth) {
                  targetW = maxWidth;
                  targetH = Math.round(maxWidth / ratio);
                }
                const canvas = document.createElement('canvas');
                canvas.width = targetW;
                canvas.height = targetH;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataUrl);
              } catch (err) {
                reject(err);
              }
            };
            img.onerror = () => reject(new Error('画像読み込み失敗'));
            img.src = reader.result;
          };
          reader.onerror = () => reject(new Error('ファイル読み込み失敗'));
          reader.readAsDataURL(file);
        });
      }

      // add images via file input (multiple)
      addImagesBtn.addEventListener('click', ()=> imagesFileInput.click());
      imagesFileInput.addEventListener('change', async (e)=>{
        const files = Array.from(e.target.files || []);
        if(files.length === 0) return;
        thumbsEl.textContent = '処理中…';
        try{
          for(const f of files){
            const dataUrl = await imageFileToCompressedDataURL(f, 1200, 0.75);
            imagesData.push(dataUrl);
          }
          renderThumbs();
          renderThumbnailOptions();
        }catch(err){
          console.error(err);
          alert('画像処理に失敗しました');
        } finally {
          imagesFileInput.value = '';
        }
      });

      clearImagesBtn.addEventListener('click', ()=>{
        if(!confirm('画像をすべてクリアしますか？')) return;
        imagesData = [];
        renderThumbs();
        renderThumbnailOptions();
        // if thumbnail was from images, clear it
        if(thumbnailSource.value === 'from_images') {
          thumbnailData = '';
          renderThumbnailPreview();
        }
      });

      // thumbnail selection logic
      thumbnailSource.addEventListener('change', ()=>{
        const v = thumbnailSource.value;
        if(v === 'from_images'){
          // show selectable list of images
          renderThumbnailOptions();
          thumbnailFileInput.style.display = 'none';
        } else if(v === 'upload_new'){
          // open file input for new thumbnail
          thumbnailFileInput.click();
        } else {
          thumbnailList.innerHTML = '';
          thumbnailFileInput.style.display = 'none';
        }
      });

      thumbnailFileInput.addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        try{
          thumbnailList.textContent = '処理中…';
          const dataUrl = await imageFileToCompressedDataURL(f, 800, 0.8);
          thumbnailData = dataUrl;
          renderThumbnailPreview();
        }catch(err){
          console.error(err);
          alert('サムネ画像の処理に失敗しました');
        } finally {
          thumbnailFileInput.value = '';
        }
      });

      function renderThumbnailOptions(){
        thumbnailList.innerHTML = '';
        if(imagesData.length === 0){
          thumbnailList.textContent = 'まず画像を追加してください。';
          return;
        }
        imagesData.forEach((d, idx)=>{
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '8px';
          row.style.marginBottom = '6px';
          const img = document.createElement('img');
          img.src = d;
          img.style.width = '64px';
          img.style.height = '64px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '6px';
          const btn = document.createElement('button');
          btn.className = 'btn ghost';
          btn.type = 'button';
          btn.textContent = 'サムネにする';
          btn.addEventListener('click', ()=> {
            thumbnailData = d;
            renderThumbnailPreview();
          });
          const label = document.createElement('div');
          label.textContent = `画像 ${idx+1}`;
          row.appendChild(img);
          row.appendChild(label);
          row.appendChild(btn);
          thumbnailList.appendChild(row);
        });
      }

      function renderThumbnailPreview(){
        if(!thumbnailData){
          thumbnailPreview.style.display = 'none';
          thumbnailPreview.innerHTML = '';
          return;
        }
        thumbnailPreview.style.display = 'block';
        thumbnailPreview.innerHTML = `<div style="font-weight:700;margin-bottom:6px">選択中のサムネ</div><img src="${thumbnailData}" alt="thumbnail" style="width:100%;border-radius:6px">`;
      }

      // circled number helper for thumbs
      function circledNumber(n){
        const map = ['①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩','⑪','⑫','⑬','⑭','⑮','⑯','⑰','⑱','⑲','⑳'];
        return (n>=1 && n<=20) ? map[n-1] : `(${n})`;
      }

      function renderThumbs(){
        thumbsEl.innerHTML = '';
        if(imagesData.length === 0){
          thumbsEl.textContent = '画像は未登録です。';
          return;
        }
        imagesData.forEach((d, idx)=>{
          const item = document.createElement('div');
          item.className = 'thumb-item';
          // badge
          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = circledNumber(idx+1);
          // image
          const img = document.createElement('img'); img.src = d; img.alt = 'img'+idx;
          const meta = document.createElement('div'); meta.className = 'thumb-meta';
          const p = document.createElement('div'); p.textContent = `画像 ${idx+1}`;
          const actions = document.createElement('div'); actions.className = 'thumb-actions';
          const up = document.createElement('button'); up.className='btn ghost'; up.type='button'; up.textContent='↑';
          const down = document.createElement('button'); down.className='btn ghost'; down.type='button'; down.textContent='↓';
          const del = document.createElement('button'); del.className='btn ghost'; del.type='button'; del.textContent='削除';
          const useAsThumb = document.createElement('button'); useAsThumb.className='btn'; useAsThumb.type='button'; useAsThumb.textContent='サムネにする';
          up.addEventListener('click', ()=> {
            if(idx === 0) return;
            const tmp = imagesData[idx-1]; imagesData[idx-1] = imagesData[idx]; imagesData[idx] = tmp;
            renderThumbs();
            renderThumbnailOptions();
          });
          down.addEventListener('click', ()=> {
            if(idx === imagesData.length-1) return;
            const tmp = imagesData[idx+1]; imagesData[idx+1] = imagesData[idx]; imagesData[idx] = tmp;
            renderThumbs();
            renderThumbnailOptions();
          });
          del.addEventListener('click', ()=> {
            if(!confirm('この画像を削除しますか？')) return;
            // if this image is currently selected as thumbnail, clear thumbnailData
            if(imagesData[idx] === thumbnailData) thumbnailData = '';
            imagesData.splice(idx,1);
            renderThumbs();
            renderThumbnailOptions();
            renderThumbnailPreview();
          });
          useAsThumb.addEventListener('click', ()=> {
            thumbnailData = d;
            renderThumbnailPreview();
          });
          actions.appendChild(up); actions.appendChild(down); actions.appendChild(del); actions.appendChild(useAsThumb);
          meta.appendChild(p); meta.appendChild(actions);
          item.appendChild(badge);
          item.appendChild(img);
          item.appendChild(meta);
          thumbsEl.appendChild(item);
        });
      }

      /* ---------- コマンドUI（コマンド文字列のみ） ---------- */
      function createCmdRow(cmdObj){
        const wrapper = document.createElement('div');
        wrapper.className = 'cmd-item';
        wrapper.dataset.id = cmdObj.id || ('cmd-' + Date.now() + Math.floor(Math.random()*1000));

        const details = document.createElement('details');
        details.open = true;
        const summary = document.createElement('summary');
        summary.textContent = cmdObj.command || '新しいコマンド';
        details.appendChild(summary);

        const row = document.createElement('div');
        row.className = 'cmd-row';

        const cmdInput = document.createElement('input');
        cmdInput.type = 'text';
        cmdInput.placeholder = '/example';
        cmdInput.value = cmdObj.command || '';
        cmdInput.addEventListener('input', ()=> {
          summary.textContent = cmdInput.value || '新しいコマンド';
        });

        const permSelect = document.createElement('select');
        const opt1 = document.createElement('option'); opt1.value='player'; opt1.textContent='player';
        const opt2 = document.createElement('option'); opt2.value='admin'; opt2.textContent='admin';
        permSelect.appendChild(opt1); permSelect.appendChild(opt2);
        permSelect.value = cmdObj.permission || 'player';

        const descArea = document.createElement('textarea');
        descArea.placeholder = 'このコマンドの詳細説明（使用例、注意点など）';
        descArea.value = cmdObj.desc || '';

        const actions = document.createElement('div');
        actions.className = 'cmd-actions';
        const upBtn = document.createElement('button'); upBtn.className='btn ghost'; upBtn.type='button'; upBtn.textContent='↑';
        const downBtn = document.createElement('button'); downBtn.className='btn ghost'; downBtn.type='button'; downBtn.textContent='↓';
        const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.type='button'; delBtn.textContent='削除';

        upBtn.addEventListener('click', ()=> {
          const parent = wrapper.parentElement;
          if(parent && wrapper.previousElementSibling) parent.insertBefore(wrapper, wrapper.previousElementSibling);
        });
        downBtn.addEventListener('click', ()=> {
          const parent = wrapper.parentElement;
          if(parent && wrapper.nextElementSibling) parent.insertBefore(wrapper.nextElementSibling, wrapper);
        });
        delBtn.addEventListener('click', ()=> {
          if(!confirm('このコマンドを削除しますか？')) return;
          wrapper.remove();
        });

        actions.appendChild(upBtn);
        actions.appendChild(downBtn);
        actions.appendChild(delBtn);

        const leftCol = document.createElement('div');
        leftCol.style.display='flex';
        leftCol.style.flexDirection='column';
        leftCol.style.gap='8px';
        leftCol.appendChild(cmdInput);

        row.appendChild(leftCol);
        row.appendChild(permSelect);
        row.appendChild(actions);

        details.appendChild(row);
        details.appendChild(descArea);
        wrapper.appendChild(details);

        return wrapper;
      }

      addCmdBtn.addEventListener('click', ()=>{
        const container = document.getElementById('cmd-container') || createCmdContainer();
        const row = createCmdRow({});
        container.appendChild(row);
      });

      function createCmdContainer(){
        let c = document.getElementById('cmd-container');
        if(c) return c;
        c = document.createElement('div');
        c.id = 'cmd-container';
        c.style.marginTop = '12px';
        document.querySelector('.add-main').appendChild(c);
        return c;
      }

      function collectCommandsFromUI(){
        const container = document.getElementById('cmd-container');
        if(!container) return [];
        const rows = Array.from(container.children);
        return rows.map(r=>{
          const id = r.dataset.id || ('cmd-' + Date.now() + Math.floor(Math.random()*1000));
          const cmdInput = r.querySelector('input[type="text"]');
          const perm = r.querySelector('select') ? r.querySelector('select').value : 'player';
          const desc = r.querySelector('textarea') ? r.querySelector('textarea').value : '';
          return { id, command: (cmdInput ? cmdInput.value.trim() : ''), permission: perm, desc: desc.trim() };
        }).filter(c => c.command);
      }

      /* 追加（上部フォーム） */
      saveBtn.addEventListener('click', ()=>{
        const name = nameInput.value.trim();
        if(!name){ alert('プラグイン名を入力してください'); return; }
        const obj = {
          id: uid(),
          name: name,
          category: categoryInput.value,
          desc: descInput.value.trim(),
          longDesc: longDescInput.value.trim(),
          images: imagesData.slice(), // save images array
          thumbnail: thumbnailData || '', // save thumbnail separately
          commands: collectCommandsFromUI()
        };
        items.push(obj);
        save();
        renderList();
        clearAddForm();
        alert('プラグインを追加しました');
      });

      newBtn.addEventListener('click', ()=> clearAddForm());

      function clearAddForm(){
        nameInput.value = '';
        categoryInput.value = 'player';
        descInput.value = '';
        longDescInput.value = '';
        imagesData = [];
        thumbnailData = '';
        renderThumbs();
        renderThumbnailOptions();
        renderThumbnailPreview();
        const c = document.getElementById('cmd-container');
        if(c) c.remove();
        saveBtn.textContent = '追加して保存';
        saveBtn.onclick = null;
        editingId = null;
      }

      /* 編集（下の一覧から） */
      function editItem(id){
        const it = items.find(x=>x.id===id);
        if(!it) return;
        // populate add form with item data for editing convenience
        nameInput.value = it.name || '';
        categoryInput.value = it.category || 'player';
        descInput.value = it.desc || '';
        longDescInput.value = it.longDesc || '';
        imagesData = Array.isArray(it.images) ? it.images.slice() : [];
        thumbnailData = it.thumbnail || '';
        renderThumbs();
        renderThumbnailOptions();
        renderThumbnailPreview();
        // commands
        const container = createCmdContainer();
        container.innerHTML = '';
        (it.commands || []).forEach(c=>{
          container.appendChild(createCmdRow(c));
        });
        // change save button behavior to update existing item
        editingId = id;
        saveBtn.textContent = '上書き保存';
        saveBtn.onclick = function(){
          const name = nameInput.value.trim();
          if(!name){ alert('プラグイン名を入力してください'); return; }
          const obj = {
            id: editingId,
            name: name,
            category: categoryInput.value,
            desc: descInput.value.trim(),
            longDesc: longDescInput.value.trim(),
            images: imagesData.slice(),
            thumbnail: thumbnailData || '',
            commands: collectCommandsFromUI()
          };
          const idx = items.findIndex(x=>x.id===editingId);
          if(idx !== -1) items[idx] = obj;
          save();
          renderList();
          clearAddForm();
          editingId = null;
          saveBtn.textContent = '追加して保存';
          saveBtn.onclick = null;
          alert('保存しました');
        };
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      /* 全て削除ボタンの処理 */
      clearAllBtn.addEventListener('click', ()=>{
        if(!confirm('本当に全てのプラグイン説明を削除しますか？ この操作は取り消せません。エクスポートでバックアップを取ってから実行してください。')) return;
        items = [];
        try{
          localStorage.removeItem(STORAGE_KEY);
          try{ window.dispatchEvent(new StorageEvent('storage', { key: STORAGE_KEY })); }catch(e){}
        }catch(e){ console.error(e); }
        renderList();
        clearAddForm();
        alert('すべてのプラグイン説明を削除しました。');
      });

      /* レンダリング */
      function renderList(){
        pluginsGrid.innerHTML = '';
        const q = (searchInput.value || '').trim().toLowerCase();
        const cat = filterCat.value;
        let filtered = items.slice();
        if(cat) filtered = filtered.filter(i=>i.category === cat);
        if(q){
          filtered = filtered.filter(i=>{
            if(i.name && i.name.toLowerCase().includes(q)) return true;
            if(i.desc && i.desc.toLowerCase().includes(q)) return true;
            if(i.longDesc && i.longDesc.toLowerCase().includes(q)) return true;
            if(Array.isArray(i.commands)){
              for(const c of i.commands){
                if((c.command && c.command.toLowerCase().includes(q)) || (c.desc && c.desc.toLowerCase().includes(q))) return true;
              }
            }
            return false;
          });
        }

        const total = filtered.length;
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if(currentPage > pages) currentPage = pages;
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);

        pageItems.forEach(it=>{
          const card = document.createElement('div');
          card.className = 'plugin-card';
          const imgWrap = document.createElement('div');
          imgWrap.style.position = 'relative';
          const img = document.createElement('img');
          img.className = 'plugin-thumb';
          // prefer thumbnail, fallback to first image, fallback to default
          img.src = it.thumbnail || (it.images && it.images[0]) || '../img/plugins/default.png';
          img.alt = it.name;
          imgWrap.appendChild(img);

          const main = document.createElement('div');
          main.className = 'plugin-main';
          const header = document.createElement('div');
          header.className = 'plugin-header';
          const title = document.createElement('h3');
          title.className = 'plugin-title';
          title.textContent = it.name + (it.category === 'admin' ? '（管理者用）' : '');
          const meta = document.createElement('div');
          meta.className = 'plugin-meta';
          meta.textContent = (it.commands ? (it.commands.length + ' コマンド') : '0 コマンド') + ' • ' + (it.desc || '');
          header.appendChild(title);
          header.appendChild(meta);

          const body = document.createElement('div');
          body.className = 'plugin-body';

          const cmdList = document.createElement('div');
          cmdList.className = 'cmd-list';
          const cmds = it.commands || [];
          cmds.slice(0,3).forEach(c=>{
            const cdiv = document.createElement('div');
            cdiv.className = 'cmd-item';
            cdiv.innerHTML = `<strong>${escapeHtml(c.command || '')}</strong> <span style="color:var(--muted)">(${c.permission||'player'})</span><div style="margin-top:6px;color:#333">${escapeHtml((c.desc||'').slice(0,200))}${(c.desc && c.desc.length>200)?'…':''}</div>`;
            cmdList.appendChild(cdiv);
          });
          if(cmds.length > 3){
            const more = document.createElement('div');
            more.className = 'note';
            more.textContent = `他 ${cmds.length - 3} 件のコマンドがあります。編集で全て確認できます。`;
            cmdList.appendChild(more);
          }

          const actions = document.createElement('div');
          actions.style.marginTop = '10px';
          const editBtn = document.createElement('button');
          editBtn.className = 'btn ghost';
          editBtn.type = 'button';
          editBtn.textContent = '編集';
          editBtn.addEventListener('click', ()=> { editItem(it.id); });
          const delBtn = document.createElement('button');
          delBtn.className = 'btn ghost';
          delBtn.type = 'button';
          delBtn.textContent = '削除';
          delBtn.addEventListener('click', ()=> {
            if(!confirm('このプラグインを削除しますか？')) return;
            items = items.filter(x=>x.id !== it.id);
            save();
            renderList();
          });
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          body.appendChild(cmdList);
          body.appendChild(actions);

          main.appendChild(header);
          main.appendChild(body);

          card.appendChild(imgWrap);
          card.appendChild(main);
          pluginsGrid.appendChild(card);
        });

        renderPager(pages, currentPage);
      }

      function renderPager(pages, current){
        pager.innerHTML = '';
        if(pages <= 1){ pager.setAttribute('aria-hidden','true'); return; }
        pager.setAttribute('aria-hidden','false');
        const prev = document.createElement('button'); prev.className='page-btn'; prev.textContent='‹';
        prev.disabled = current === 1;
        prev.addEventListener('click', ()=> { currentPage = Math.max(1, currentPage-1); renderList(); });
        pager.appendChild(prev);
        for(let i=1;i<=pages;i++){
          const b = document.createElement('button'); b.className='page-btn'; b.textContent = i;
          if(i === current) b.style.fontWeight = '800';
          b.addEventListener('click', ()=> { currentPage = i; renderList(); });
          pager.appendChild(b);
        }
        const next = document.createElement('button'); next.className='page-btn'; next.textContent='›';
        next.disabled = current === pages;
        next.addEventListener('click', ()=> { currentPage = Math.min(pages, currentPage+1); renderList(); });
        pager.appendChild(next);
      }

      /* import/export */
      exportBtn.addEventListener('click', ()=>{
        const data = JSON.stringify(items, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'alpha_plugins_export.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      importBtn.addEventListener('click', ()=> importFile.click());
      importFile.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=> {
          try{
            const parsed = JSON.parse(reader.result);
            if(!Array.isArray(parsed)) throw new Error('不正な形式');
            const normalized = parsed.map(p=> ({
              id: p.id || uid(),
              name: p.name||'',
              category: p.category||'player',
              desc: p.desc||'',
              longDesc: p.longDesc||'',
              images: Array.isArray(p.images) ? p.images.slice() : (p.icon ? [p.icon] : []),
              thumbnail: p.thumbnail || (p.icon || ''),
              commands: Array.isArray(p.commands) ? p.commands.map(c => ({
                id: c.id || ('cmd-' + Date.now() + Math.floor(Math.random()*1000)),
                command: (c.command || '').trim(),
                permission: c.permission || 'player',
                desc: c.desc || ''
              })).filter(Boolean) : []
            }));
            items = items.concat(normalized);
            save();
            renderList();
            alert('インポート完了（既存データに追加されました）');
          }catch(err){
            alert('インポートに失敗しました：' + err.message);
          }
        };
        reader.readAsText(f);
      });

      // events
      searchInput.addEventListener('input', ()=> { currentPage = 1; renderList(); });
      filterCat.addEventListener('change', ()=> { currentPage = 1; renderList(); });

      window.addEventListener('storage', (e)=>{
        if(e.key === STORAGE_KEY) { load(); renderList(); }
      });

      function escapeHtml(str){
        if(!str) return '';
        return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
      }

      // init
      load();
      renderList();
      renderThumbs();
      renderThumbnailOptions();
      renderThumbnailPreview();

    })();
  </script>
</body>
</html>
