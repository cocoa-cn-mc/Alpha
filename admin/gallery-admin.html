<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>プラグイン管理 - α鯖</title>
  <link rel="icon" href="../img/favicon.png" type="image/png">
  <style>
    :root{
      --accent:#2b8a3e;
      --muted:#6b7280;
      --bg:#f6f8fa;
      --card:#fff;
      --maxw:1200px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter","Noto Sans JP",sans-serif;background:var(--bg);color:#111}
    header{background:linear-gradient(180deg,#0b1220,#0f172a);color:#fff;padding:20px;text-align:center}
    main{max-width:var(--maxw);margin:18px auto;padding:18px}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:18px}
    /* サイド（フォーム） */
    .panel{background:var(--card);padding:12px;border-radius:10px;border:1px solid #e6eef6}
    label{display:block;font-weight:700;margin-top:8px}
    input[type="text"], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef6;margin-top:6px}
    .actions{display:flex;gap:8px;margin-top:10px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #e6eef6}
    .small{font-size:0.9rem;color:var(--muted);margin-top:8px}
    /* メイン（大きめリスト） */
    .controls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .search{display:flex;gap:8px;align-items:center}
    .search input{padding:8px;border-radius:8px;border:1px solid #e6eef6}
    .plugins-grid{display:flex;flex-direction:column;gap:12px}
    .plugin-card{background:var(--card);border-radius:12px;padding:14px;border:1px solid #e6eef6;display:flex;gap:12px;align-items:flex-start}
    .plugin-thumb{width:120px;height:120px;border-radius:10px;object-fit:cover;flex:0 0 120px;background:#f1f5f9}
    .plugin-main{flex:1}
    .plugin-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .plugin-title{font-size:1.1rem;margin:0}
    .plugin-meta{color:var(--muted);font-size:0.95rem}
    .plugin-body{margin-top:8px;display:flex;gap:12px}
    .cmd-list{flex:1}
    .cmd-item{background:#fafafa;border-radius:8px;padding:8px;margin-bottom:8px;border:1px solid #eef2f6}
    .cmd-row{display:flex;gap:8px;align-items:flex-start}
    .cmd-row input[type="text"]{flex:0 0 260px}
    .cmd-row textarea{flex:1;min-height:56px}
    .cmd-actions{display:flex;gap:6px;align-items:center;margin-left:auto}
    .accordion{margin-top:8px}
    .accordion summary{cursor:pointer;font-weight:700;padding:8px;background:#f7fafc;border-radius:8px;border:1px solid #eef2f6}
    .uploader{display:flex;gap:8px;align-items:center;margin-top:8px}
    .uploader input[type="file"]{display:block}
    .note{font-size:0.9rem;color:var(--muted);margin-top:8px}
    /* pagination */
    .pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px}
    .page-btn{padding:6px 10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;cursor:pointer}
    /* responsive */
    @media (max-width:980px){ .layout{grid-template-columns:1fr} .plugin-thumb{width:96px;height:96px} }
  </style>
</head>
<body>
  <header>
    <h1>プラグイン管理</h1>
    <p style="margin:6px 0 0;opacity:0.9">公開ページからはアクセスできない管理画面です。ここで詳細を編集してください。</p>
  </header>

  <main>
    <div class="layout">
      <!-- サイドフォーム -->
      <aside class="panel" aria-label="プラグイン編集フォーム">
        <h3 id="form-title">プラグインを追加</h3>

        <label for="pl-name">名前</label>
        <input id="pl-name" type="text" placeholder="例：ホーム（/home）">

        <label for="pl-category">カテゴリ</label>
        <select id="pl-category">
          <option value="player">一般プレイヤー用</option>
          <option value="admin">管理者用</option>
        </select>

        <label for="pl-desc">短い説明（一覧用）</label>
        <input id="pl-desc" type="text" placeholder="一覧に表示する短い説明">

        <label for="pl-long-desc">詳細説明（公開ページでの詳細）</label>
        <textarea id="pl-long-desc" rows="4" placeholder="プラグインの詳細な説明や注意点"></textarea>

        <label>アイコン（画像アップロード）</label>
        <div class="uploader">
          <input id="pl-icon-file" type="file" accept="image/*">
          <button id="clear-icon" class="btn ghost" type="button">クリア</button>
        </div>
        <div id="icon-preview" style="margin-top:8px"></div>

        <label>コマンド（個別に追加）</label>
        <div class="note">コマンドは「コマンド文字列」「説明」「権限」を個別に設定します。表示名は使いません。</div>

        <div class="actions">
          <button id="add-cmd" class="btn ghost" type="button">コマンドを追加</button>
          <button id="save-btn" class="btn" type="button">保存</button>
          <button id="new-btn" class="btn ghost" type="button">新規</button>
        </div>

        <div class="small">変更は localStorage に保存され、公開ページに反映されます。</div>
      </aside>

      <!-- メイン：大きめリスト -->
      <section>
        <div class="panel" aria-label="プラグイン一覧">
          <div class="controls">
            <div class="search">
              <input id="search-input" type="text" placeholder="検索：名前・説明・コマンド">
              <select id="filter-cat">
                <option value="">すべてのカテゴリ</option>
                <option value="player">一般プレイヤー用</option>
                <option value="admin">管理者用</option>
              </select>
            </div>
            <div>
              <button id="export-btn" class="btn ghost" type="button">エクスポート</button>
              <button id="import-btn" class="btn ghost" type="button">インポート</button>
              <input id="import-file" type="file" accept="application/json" style="display:none">
            </div>
          </div>

          <div id="plugins-grid" class="plugins-grid" aria-live="polite"></div>

          <div class="pager" id="pager" aria-hidden="true"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
    (function(){
      const STORAGE_KEY = 'alpha_plugins_v1';
      const PAGE_SIZE = 6;

      // DOM
      const nameInput = document.getElementById('pl-name');
      const categoryInput = document.getElementById('pl-category');
      const descInput = document.getElementById('pl-desc');
      const longDescInput = document.getElementById('pl-long-desc');
      const iconFileInput = document.getElementById('pl-icon-file');
      const iconPreview = document.getElementById('icon-preview');
      const clearIconBtn = document.getElementById('clear-icon');
      const addCmdBtn = document.getElementById('add-cmd');
      const saveBtn = document.getElementById('save-btn');
      const newBtn = document.getElementById('new-btn');
      const pluginsGrid = document.getElementById('plugins-grid');
      const searchInput = document.getElementById('search-input');
      const filterCat = document.getElementById('filter-cat');
      const pager = document.getElementById('pager');
      const importBtn = document.getElementById('import-btn');
      const exportBtn = document.getElementById('export-btn');
      const importFile = document.getElementById('import-file');

      // state
      let items = [];
      let editingId = null;
      let currentPage = 1;
      let iconDataUrl = '';

      // util load/save
      function load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          items = raw ? JSON.parse(raw) : [];
        }catch(e){ items = []; }
      }
      function save(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        try{ window.dispatchEvent(new StorageEvent('storage', { key: STORAGE_KEY })); }catch(e){}
      }

      function uid(){ return 'pl-' + Date.now() + '-' + Math.floor(Math.random()*1000); }

      /* ---------- 画像アップロード（圧縮して dataURL） ---------- */
      function imageFileToCompressedDataURL(file, maxWidth = 1200, quality = 0.75) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const reader = new FileReader();
          reader.onload = () => {
            img.onload = () => {
              try {
                const ratio = img.width / img.height || 1;
                let targetW = img.width;
                let targetH = img.height;
                if (img.width > maxWidth) {
                  targetW = maxWidth;
                  targetH = Math.round(maxWidth / ratio);
                }
                const canvas = document.createElement('canvas');
                canvas.width = targetW;
                canvas.height = targetH;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataUrl);
              } catch (err) {
                reject(err);
              }
            };
            img.onerror = () => reject(new Error('画像読み込み失敗'));
            img.src = reader.result;
          };
          reader.onerror = () => reject(new Error('ファイル読み込み失敗'));
          reader.readAsDataURL(file);
        });
      }

      iconFileInput.addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        try{
          iconPreview.textContent = '処理中…';
          const dataUrl = await imageFileToCompressedDataURL(f, 1200, 0.75);
          iconDataUrl = dataUrl;
          iconPreview.innerHTML = `<img src="${dataUrl}" alt="icon" style="width:100%;border-radius:8px">`;
        }catch(err){
          console.error(err);
          alert('画像処理に失敗しました');
          iconPreview.textContent = '';
        }
      });

      clearIconBtn.addEventListener('click', ()=>{
        iconFileInput.value = '';
        iconDataUrl = '';
        iconPreview.innerHTML = '';
      });

      /* ---------- コマンド編集UI（表示名を廃止：コマンド文字列のみ） ---------- */
      function createCmdRow(cmdObj){
        // cmdObj: { id, command, desc, permission }
        const wrapper = document.createElement('div');
        wrapper.className = 'cmd-item';
        wrapper.dataset.id = cmdObj.id || ('cmd-' + Date.now() + Math.floor(Math.random()*1000));

        const details = document.createElement('details');
        details.open = true;
        const summary = document.createElement('summary');
        summary.textContent = cmdObj.command || '新しいコマンド';
        details.appendChild(summary);

        const row = document.createElement('div');
        row.className = 'cmd-row';

        // コマンド文字列入力（例: /home）
        const cmdInput = document.createElement('input');
        cmdInput.type = 'text';
        cmdInput.placeholder = '/example';
        cmdInput.value = cmdObj.command || '';
        cmdInput.addEventListener('input', ()=> {
          summary.textContent = cmdInput.value || '新しいコマンド';
        });

        // 権限セレクト
        const permSelect = document.createElement('select');
        const opt1 = document.createElement('option'); opt1.value='player'; opt1.textContent='player';
        const opt2 = document.createElement('option'); opt2.value='admin'; opt2.textContent='admin';
        permSelect.appendChild(opt1); permSelect.appendChild(opt2);
        permSelect.value = cmdObj.permission || 'player';

        // 説明（長文）
        const descArea = document.createElement('textarea');
        descArea.placeholder = 'このコマンドの詳細説明（使用例、注意点など）';
        descArea.value = cmdObj.desc || '';

        // 行操作ボタン
        const actions = document.createElement('div');
        actions.className = 'cmd-actions';
        const upBtn = document.createElement('button'); upBtn.className='btn ghost'; upBtn.type='button'; upBtn.textContent='↑';
        const downBtn = document.createElement('button'); downBtn.className='btn ghost'; downBtn.type='button'; downBtn.textContent='↓';
        const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.type='button'; delBtn.textContent='削除';

        upBtn.addEventListener('click', ()=> {
          const parent = wrapper.parentElement;
          if(parent && wrapper.previousElementSibling) parent.insertBefore(wrapper, wrapper.previousElementSibling);
        });
        downBtn.addEventListener('click', ()=> {
          const parent = wrapper.parentElement;
          if(parent && wrapper.nextElementSibling) parent.insertBefore(wrapper.nextElementSibling, wrapper);
        });
        delBtn.addEventListener('click', ()=> {
          if(!confirm('このコマンドを削除しますか？')) return;
          wrapper.remove();
        });

        actions.appendChild(upBtn);
        actions.appendChild(downBtn);
        actions.appendChild(delBtn);

        const leftCol = document.createElement('div');
        leftCol.style.display='flex';
        leftCol.style.flexDirection='column';
        leftCol.style.gap='8px';
        leftCol.appendChild(cmdInput);

        row.appendChild(leftCol);
        row.appendChild(permSelect);
        row.appendChild(actions);

        details.appendChild(row);
        details.appendChild(descArea);
        wrapper.appendChild(details);

        return wrapper;
      }

      addCmdBtn.addEventListener('click', ()=>{
        const container = document.getElementById('cmd-container') || createCmdContainer();
        const row = createCmdRow({});
        container.appendChild(row);
      });

      function createCmdContainer(){
        let c = document.getElementById('cmd-container');
        if(c) return c;
        c = document.createElement('div');
        c.id = 'cmd-container';
        c.style.marginTop = '12px';
        document.querySelector('.panel').appendChild(c);
        return c;
      }

      function collectCommandsFromUI(){
        const container = document.getElementById('cmd-container');
        if(!container) return [];
        const rows = Array.from(container.children);
        return rows.map(r=>{
          const id = r.dataset.id || ('cmd-' + Date.now() + Math.floor(Math.random()*1000));
          const cmdInput = r.querySelector('input[type="text"]');
          const perm = r.querySelector('select') ? r.querySelector('select').value : 'player';
          const desc = r.querySelector('textarea') ? r.querySelector('textarea').value : '';
          return { id, command: (cmdInput ? cmdInput.value.trim() : ''), permission: perm, desc: desc.trim() };
        }).filter(c => c.command); // コマンド文字列が空の行は除外
      }

      /* ---------- 保存 / 新規 / 編集 ---------- */
      saveBtn.addEventListener('click', ()=>{
        const name = nameInput.value.trim();
        if(!name){ alert('プラグイン名を入力してください'); return; }
        const obj = {
          id: editingId || uid(),
          name: name,
          category: categoryInput.value,
          desc: descInput.value.trim(),
          longDesc: longDescInput.value.trim(),
          icon: iconDataUrl || '',
          commands: collectCommandsFromUI()
        };
        if(editingId){
          const idx = items.findIndex(x=>x.id===editingId);
          if(idx !== -1) items[idx] = obj;
        } else {
          items.push(obj);
        }
        save();
        renderList();
        clearForm();
        alert('保存しました');
      });

      newBtn.addEventListener('click', ()=> clearForm());

      function clearForm(){
        editingId = null;
        document.getElementById('form-title').textContent = 'プラグインを追加';
        nameInput.value = '';
        categoryInput.value = 'player';
        descInput.value = '';
        longDescInput.value = '';
        iconFileInput.value = '';
        iconDataUrl = '';
        iconPreview.innerHTML = '';
        const c = document.getElementById('cmd-container');
        if(c) c.remove();
      }

      function editItem(id){
        const it = items.find(x=>x.id===id);
        if(!it) return;
        editingId = id;
        document.getElementById('form-title').textContent = 'プラグインを編集';
        nameInput.value = it.name || '';
        categoryInput.value = it.category || 'player';
        descInput.value = it.desc || '';
        longDescInput.value = it.longDesc || '';
        iconDataUrl = it.icon || '';
        iconPreview.innerHTML = iconDataUrl ? `<img src="${iconDataUrl}" alt="icon" style="width:100%;border-radius:8px">` : '';
        // commands
        const container = createCmdContainer();
        container.innerHTML = '';
        (it.commands || []).forEach(c=>{
          container.appendChild(createCmdRow(c));
        });
      }

      /* ---------- レンダリング（大きめリスト） ---------- */
      function renderList(){
        pluginsGrid.innerHTML = '';
        const q = (searchInput.value || '').trim().toLowerCase();
        const cat = filterCat.value;
        let filtered = items.slice();
        if(cat) filtered = filtered.filter(i=>i.category === cat);
        if(q){
          filtered = filtered.filter(i=>{
            if(i.name && i.name.toLowerCase().includes(q)) return true;
            if(i.desc && i.desc.toLowerCase().includes(q)) return true;
            if(i.longDesc && i.longDesc.toLowerCase().includes(q)) return true;
            if(Array.isArray(i.commands)){
              for(const c of i.commands){
                if((c.command && c.command.toLowerCase().includes(q)) || (c.desc && c.desc.toLowerCase().includes(q))) return true;
              }
            }
            return false;
          });
        }

        // pagination
        const total = filtered.length;
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if(currentPage > pages) currentPage = pages;
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);

        pageItems.forEach(it=>{
          const card = document.createElement('div');
          card.className = 'plugin-card';
          const img = document.createElement('img');
          img.className = 'plugin-thumb';
          img.src = it.icon || '../img/plugins/default.png';
          img.alt = it.name;
          const main = document.createElement('div');
          main.className = 'plugin-main';
          const header = document.createElement('div');
          header.className = 'plugin-header';
          const title = document.createElement('h3');
          title.className = 'plugin-title';
          title.textContent = it.name + (it.category === 'admin' ? '（管理者用）' : '');
          const meta = document.createElement('div');
          meta.className = 'plugin-meta';
          meta.textContent = (it.commands ? (it.commands.length + ' コマンド') : '0 コマンド') + ' • ' + (it.desc || '');
          header.appendChild(title);
          header.appendChild(meta);

          const body = document.createElement('div');
          body.className = 'plugin-body';

          // commands preview (first 3)
          const cmdList = document.createElement('div');
          cmdList.className = 'cmd-list';
          const cmds = it.commands || [];
          cmds.slice(0,3).forEach(c=>{
            const cdiv = document.createElement('div');
            cdiv.className = 'cmd-item';
            cdiv.innerHTML = `<strong>${escapeHtml(c.command || '')}</strong> <span style="color:var(--muted)">(${c.permission||'player'})</span><div style="margin-top:6px;color:#333">${escapeHtml((c.desc||'').slice(0,200))}${(c.desc && c.desc.length>200)?'…':''}</div>`;
            cmdList.appendChild(cdiv);
          });
          if(cmds.length > 3){
            const more = document.createElement('div');
            more.className = 'note';
            more.textContent = `他 ${cmds.length - 3} 件のコマンドがあります。編集で全て確認できます。`;
            cmdList.appendChild(more);
          }

          const actions = document.createElement('div');
          actions.style.marginTop = '10px';
          const editBtn = document.createElement('button');
          editBtn.className = 'btn ghost';
          editBtn.type = 'button';
          editBtn.textContent = '編集';
          editBtn.addEventListener('click', ()=> {
            editItem(it.id);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          const delBtn = document.createElement('button');
          delBtn.className = 'btn ghost';
          delBtn.type = 'button';
          delBtn.textContent = '削除';
          delBtn.addEventListener('click', ()=> {
            if(!confirm('このプラグインを削除しますか？')) return;
            items = items.filter(x=>x.id !== it.id);
            save();
            renderList();
          });
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          body.appendChild(cmdList);
          body.appendChild(actions);

          main.appendChild(header);
          main.appendChild(body);

          card.appendChild(img);
          card.appendChild(main);
          pluginsGrid.appendChild(card);
        });

        // pager
        renderPager(pages, currentPage);
      }

      function renderPager(pages, current){
        pager.innerHTML = '';
        if(pages <= 1){ pager.setAttribute('aria-hidden','true'); return; }
        pager.setAttribute('aria-hidden','false');
        const prev = document.createElement('button'); prev.className='page-btn'; prev.textContent='‹';
        prev.disabled = current === 1;
        prev.addEventListener('click', ()=> { currentPage = Math.max(1, currentPage-1); renderList(); });
        pager.appendChild(prev);
        for(let i=1;i<=pages;i++){
          const b = document.createElement('button'); b.className='page-btn'; b.textContent = i;
          if(i === current) b.style.fontWeight = '800';
          b.addEventListener('click', ()=> { currentPage = i; renderList(); });
          pager.appendChild(b);
        }
        const next = document.createElement('button'); next.className='page-btn'; next.textContent='›';
        next.disabled = current === pages;
        next.addEventListener('click', ()=> { currentPage = Math.min(pages, currentPage+1); renderList(); });
        pager.appendChild(next);
      }

      /* ---------- import/export (簡易) ---------- */
      exportBtn.addEventListener('click', ()=>{
        const data = JSON.stringify(items, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'alpha_plugins_export.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      importBtn.addEventListener('click', ()=> importFile.click());
      importFile.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=> {
          try{
            const parsed = JSON.parse(reader.result);
            if(!Array.isArray(parsed)) throw new Error('不正な形式');
            // append imported items (ensure id and command shape)
            const normalized = parsed.map(p=> ({
              id: p.id || uid(),
              name: p.name||'',
              category: p.category||'player',
              desc: p.desc||'',
              longDesc: p.longDesc||'',
              icon: p.icon||'',
              commands: Array.isArray(p.commands) ? p.commands.map(c => ({
                id: c.id || ('cmd-' + Date.now() + Math.floor(Math.random()*1000)),
                command: (c.command || '').trim(),
                permission: c.permission || 'player',
                desc: c.desc || ''
              })).filter(Boolean) : []
            }));
            items = items.concat(normalized);
            save();
            renderList();
            alert('インポート完了（既存データに追加されました）');
          }catch(err){
            alert('インポートに失敗しました：' + err.message);
          }
        };
        reader.readAsText(f);
      });

      /* ---------- 初期サンプル（初回のみ） ---------- */
      function ensureSample(){
        load();
        if(items.length === 0){
          items = [
            { id:'p-chat', name:'簡易チャットフィルター', category:'player', desc:'不適切な言葉を自動でマスクします。', longDesc:'チャットの不適切語を検出してマスクします。感度設定あり。', icon:'../img/plugins/chat-filter.png', commands:[{id:'c1', command:'/filter', permission:'admin', desc:'フィルターのON/OFFを切替'}] },
            { id:'p-home', name:'ホーム（/home）', category:'player', desc:'拠点を登録してワープできます。', longDesc:'/sethome で拠点を登録、/home でワープ。複数拠点対応オプションあり。', icon:'../img/plugins/home.png', commands:[{id:'c2', command:'/sethome', permission:'player', desc:'現在地をホームに設定'},{id:'c3', command:'/home', permission:'player', desc:'登録したホームへワープ'}] },
            { id:'a-rollback', name:'ロールバック管理', category:'admin', desc:'荒らしをロールバックします。', longDesc:'指定時間内の破壊・設置を巻き戻す管理者向けツール。ログと併用してください。', icon:'../img/plugins/rollback.png', commands:[{id:'c4', command:'/rollback', permission:'admin', desc:'指定時間をロールバック'}] }
          ];
          save();
        }
      }

      // events
      searchInput.addEventListener('input', ()=> { currentPage = 1; renderList(); });
      filterCat.addEventListener('change', ()=> { currentPage = 1; renderList(); });

      window.addEventListener('storage', (e)=>{
        if(e.key === STORAGE_KEY) { load(); renderList(); }
      });

      // helper: escape HTML
      function escapeHtml(str){
        if(!str) return '';
        return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
      }

      // init
      ensureSample();
      load();
      renderList();

    })();
  </script>
</body>
</html>
