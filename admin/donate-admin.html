<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>寄付管理 - 管理画面</title>
  <style>
    :root{--accent:#2b8a3e;--muted:#6b7280;--bg:#f6f8fa;--card:#fff;--maxw:1100px}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:#111}
    header{background:linear-gradient(180deg,#0b1220,#0f172a);color:#fff;padding:18px;text-align:center}
    main{max-width:var(--maxw);margin:18px auto;padding:18px}
    .panel{background:var(--card);padding:14px;border-radius:10px;border:1px solid #e6eef6;margin-bottom:14px}
    label{display:block;font-weight:700;margin-top:10px}
    input[type="text"], input[type="number"], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef6;margin-top:6px}
    textarea{min-height:80px}
    .row{display:flex;gap:12px;align-items:flex-start}
    .col{flex:1}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #e6eef6}
    .btn.warn{background:#d9534f}
    .campaigns{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .campaign{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:8px;border:1px solid #eef2f6;background:#fff}
    .thumb{width:120px;height:80px;object-fit:cover;border-radius:6px;background:#f1f5f9}
    .meta{color:var(--muted);font-size:0.9rem}
    .small{font-size:0.9rem;color:var(--muted);margin-top:8px}
    @media (max-width:900px){ .row{flex-direction:column} .thumb{width:100%;height:160px} }
  </style>
</head>
<body>
  <header>
    <h1>寄付管理</h1>
    <p style="margin:6px 0 0;opacity:0.9">寄付募集（キャンペーン）と支払い案内を管理します。公開ページに即反映されます。</p>
  </header>

  <main>
    <section class="panel" aria-label="寄付ページ上部説明">
      <h2>ページ上部の説明（公開ページに表示）</h2>
      <label for="page-desc">簡単な説明（上部）</label>
      <textarea id="page-desc" placeholder="寄付ページの冒頭に表示する短い説明"></textarea>

      <label for="payment-info">支払い案内（公開時に表示される文面）</label>
      <textarea id="payment-info" placeholder="銀行口座やPayPal、振込先の案内などを記載"></textarea>

      <div style="margin-top:10px">
        <button id="save-page" class="btn">保存</button>
        <button id="reset-page" class="btn ghost">リセット</button>
      </div>
      <div class="small">保存先: <code>alpha_donation_info_v1</code></div>
    </section>

    <section class="panel" aria-label="寄付キャンペーン管理">
      <h2>寄付キャンペーン（追加・編集）</h2>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <label for="camp-title">タイトル</label>
          <input id="camp-title" type="text" placeholder="例：サーバー維持費（半年分）">

          <label for="camp-short">簡単な説明（上部に表示）</label>
          <input id="camp-short" type="text" placeholder="例：サーバーの運用費を支援してください">

          <label for="camp-usage">使い道（何ができるか）</label>
          <textarea id="camp-usage" placeholder="寄付で何を実現するかを具体的に記載"></textarea>

          <label for="camp-min">最低目標金額（表示用）</label>
          <input id="camp-min" type="number" min="0" placeholder="例：10000">

          <label for="camp-goal">目標金額</label>
          <input id="camp-goal" type="number" min="0" placeholder="例：50000">

          <label for="camp-priority">優先度</label>
          <select id="camp-priority">
            <option value="low">低</option>
            <option value="medium">中</option>
            <option value="high">高</option>
          </select>

          <label for="camp-achieved" style="margin-top:8px">達成済み</label>
          <select id="camp-achieved">
            <option value="false">未達成</option>
            <option value="true">達成</option>
          </select>

          <div style="margin-top:10px" class="row">
            <button id="add-campaign" class="btn">追加 / 保存</button>
            <button id="clear-form" class="btn ghost">フォームをクリア</button>
          </div>
        </div>

        <aside style="width:320px;min-width:260px">
          <label>画像（任意）</label>
          <input id="camp-file" type="file" accept="image/*">
          <div id="camp-preview" style="margin-top:8px"></div>
          <div class="small" style="margin-top:8px">画像はクライアントで圧縮して dataURL として保存します。</div>
        </aside>
      </div>

      <h3 style="margin-top:14px">既存のキャンペーン</h3>
      <div id="campaigns" class="campaigns"></div>

      <div style="margin-top:12px" class="row">
        <button id="export-camps" class="btn ghost">エクスポート</button>
        <button id="import-camps" class="btn ghost">インポート</button>
        <input id="import-file" type="file" accept="application/json" style="display:none">
        <button id="clear-camps" class="btn warn">全て削除</button>
      </div>
      <div class="small" style="margin-top:8px">保存先: <code>alpha_donations_v1</code></div>
    </section>
  </main>

  <script>
    (function(){
      const INFO_KEY = 'alpha_donation_info_v1';
      const CAMPS_KEY = 'alpha_donations_v1';

      // page info DOM
      const pageDesc = document.getElementById('page-desc');
      const paymentInfo = document.getElementById('payment-info');
      const savePageBtn = document.getElementById('save-page');
      const resetPageBtn = document.getElementById('reset-page');

      // campaign DOM
      const titleEl = document.getElementById('camp-title');
      const shortEl = document.getElementById('camp-short');
      const usageEl = document.getElementById('camp-usage');
      const minEl = document.getElementById('camp-min');
      const goalEl = document.getElementById('camp-goal');
      const priorityEl = document.getElementById('camp-priority');
      const achievedEl = document.getElementById('camp-achieved');
      const fileEl = document.getElementById('camp-file');
      const previewEl = document.getElementById('camp-preview');
      const addBtn = document.getElementById('add-campaign');
      const clearFormBtn = document.getElementById('clear-form');
      const campaignsEl = document.getElementById('campaigns');

      const exportBtn = document.getElementById('export-camps');
      const importBtn = document.getElementById('import-camps');
      const importFile = document.getElementById('import-file');
      const clearCampsBtn = document.getElementById('clear-camps');

      let camps = [];
      let editingId = null;
      let previewData = '';

      function uid(){ return 'c-' + Date.now() + '-' + Math.floor(Math.random()*1000); }

      function loadInfo(){
        try{ const raw = localStorage.getItem(INFO_KEY); return raw ? JSON.parse(raw) : {}; }catch(e){ return {}; }
      }
      function saveInfo(obj){
        localStorage.setItem(INFO_KEY, JSON.stringify(obj));
        try{ window.dispatchEvent(new StorageEvent('storage', { key: INFO_KEY })); }catch(e){}
      }

      function loadCamps(){
        try{ const raw = localStorage.getItem(CAMPS_KEY); camps = raw ? JSON.parse(raw) : []; }catch(e){ camps = []; }
      }
      function saveCamps(){
        localStorage.setItem(CAMPS_KEY, JSON.stringify(camps));
        try{ window.dispatchEvent(new StorageEvent('storage', { key: CAMPS_KEY })); }catch(e){}
      }

      // image helper
      function imageFileToCompressedDataURL(file, maxWidth = 1200, quality = 0.8){
        return new Promise((resolve,reject)=>{
          const reader = new FileReader();
          const img = new Image();
          reader.onload = ()=> {
            img.onload = ()=>{
              try{
                const ratio = img.width / img.height || 1;
                let targetW = img.width;
                if(img.width > maxWidth) targetW = maxWidth;
                const targetH = Math.round(targetW / ratio);
                const canvas = document.createElement('canvas');
                canvas.width = targetW; canvas.height = targetH;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(img,0,0,canvas.width,canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataUrl);
              }catch(err){ reject(err); }
            };
            img.onerror = ()=> reject(new Error('画像読み込み失敗'));
            img.src = reader.result;
          };
          reader.onerror = ()=> reject(new Error('ファイル読み込み失敗'));
          reader.readAsDataURL(file);
        });
      }

      // populate page info
      function populateInfo(){
        const info = loadInfo();
        pageDesc.value = info.description || '';
        paymentInfo.value = info.payment || '';
      }

      savePageBtn.addEventListener('click', ()=>{
        const obj = { description: pageDesc.value.trim(), payment: paymentInfo.value.trim(), updatedAt: Date.now() };
        saveInfo(obj);
        alert('ページ説明を保存しました');
      });
      resetPageBtn.addEventListener('click', ()=>{
        if(!confirm('ページ説明をリセットしますか？')) return;
        saveInfo({});
        populateInfo();
      });

      // campaign image
      fileEl.addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        try{
          previewEl.textContent = '処理中…';
          const dataUrl = await imageFileToCompressedDataURL(f, 1200, 0.8);
          previewData = dataUrl;
          previewEl.innerHTML = `<img src="${dataUrl}" alt="thumb" class="thumb">`;
        }catch(err){ alert('画像処理に失敗しました'); console.error(err); previewEl.textContent = ''; previewData = ''; }
        finally { fileEl.value = ''; }
      });

      // add / save campaign
      addBtn.addEventListener('click', ()=>{
        const title = titleEl.value.trim();
        if(!title){ alert('タイトルを入力してください'); return; }
        const obj = {
          id: editingId || uid(),
          title,
          short: shortEl.value.trim(),
          usage: usageEl.value.trim(),
          min: Number(minEl.value) || 0,
          goal: Number(goalEl.value) || 0,
          achieved: achievedEl.value === 'true',
          priority: priorityEl.value,
          image: previewData || '',
          createdAt: Date.now()
        };
        if(editingId){
          const idx = camps.findIndex(c=>c.id===editingId);
          if(idx !== -1) camps[idx] = obj;
        } else {
          camps.push(obj);
        }
        saveCamps();
        renderCamps();
        clearForm();
        alert('保存しました');
      });

      function clearForm(){
        editingId = null;
        titleEl.value = '';
        shortEl.value = '';
        usageEl.value = '';
        minEl.value = '';
        goalEl.value = '';
        priorityEl.value = 'medium';
        achievedEl.value = 'false';
        previewData = '';
        previewEl.innerHTML = '';
      }

      function renderCamps(){
        loadCamps();
        campaignsEl.innerHTML = '';
        if(!camps || camps.length === 0){ campaignsEl.textContent = 'キャンペーンは登録されていません。'; return; }
        camps.forEach(c=>{
          const item = document.createElement('div'); item.className = 'campaign';
          const img = document.createElement('img'); img.className = 'thumb'; img.src = c.image || ''; img.alt = c.title || '';
          const body = document.createElement('div'); body.style.flex = '1';
          const h = document.createElement('div'); h.style.fontWeight='800'; h.textContent = c.title;
          const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${c.short || ''}  優先度: ${c.priority}  ${c.achieved ? '達成' : '未達成'}`;
          const p = document.createElement('div'); p.style.marginTop='8px'; p.style.whiteSpace='pre-wrap'; p.textContent = `使い道: ${c.usage || '—'}`;
          const goals = document.createElement('div'); goals.style.marginTop='8px'; goals.innerHTML = `<strong>最低目標:</strong> ${c.min} 円　<strong>目標:</strong> ${c.goal} 円`;
          const controls = document.createElement('div'); controls.style.marginTop='8px'; controls.style.display='flex'; controls.style.gap='8px';
          const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='編集';
          const del = document.createElement('button'); del.className='btn warn'; del.textContent='削除';
          edit.addEventListener('click', ()=> loadForEdit(c.id));
          del.addEventListener('click', ()=> {
            if(!confirm('このキャンペーンを削除しますか？')) return;
            camps = camps.filter(x=>x.id !== c.id);
            saveCamps();
            renderCamps();
          });
          controls.appendChild(edit); controls.appendChild(del);

          body.appendChild(h); body.appendChild(meta); body.appendChild(p); body.appendChild(goals); body.appendChild(controls);
          item.appendChild(img); item.appendChild(body);
          campaignsEl.appendChild(item);
        });
      }

      function loadForEdit(id){
        const c = camps.find(x=>x.id===id);
        if(!c) return;
        editingId = id;
        titleEl.value = c.title || '';
        shortEl.value = c.short || '';
        usageEl.value = c.usage || '';
        minEl.value = c.min || '';
        goalEl.value = c.goal || '';
        priorityEl.value = c.priority || 'medium';
        achievedEl.value = c.achieved ? 'true' : 'false';
        previewData = c.image || '';
        previewEl.innerHTML = previewData ? `<img src="${previewData}" class="thumb">` : '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // export/import
      exportBtn.addEventListener('click', ()=>{
        const data = JSON.stringify(camps, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'alpha_donations_export.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      importBtn.addEventListener('click', ()=> importFile.click());
      importFile.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=> {
          try{
            const parsed = JSON.parse(reader.result);
            if(!Array.isArray(parsed)) throw new Error('不正な形式');
            const normalized = parsed.map(p=>({
              id: p.id || uid(),
              title: p.title || '',
              short: p.short || '',
              usage: p.usage || '',
              min: p.min || 0,
              goal: p.goal || 0,
              achieved: !!p.achieved,
              priority: p.priority || 'medium',
              image: p.image || '',
              createdAt: p.createdAt || Date.now()
            }));
            camps = camps.concat(normalized);
            saveCamps();
            renderCamps();
            alert('インポート完了');
          }catch(err){ alert('インポートに失敗しました：' + err.message); }
        };
        reader.readAsText(f);
      });

      clearCampsBtn.addEventListener('click', ()=>{
        if(!confirm('全てのキャンペーンを削除しますか？ この操作は取り消せません。')) return;
        camps = [];
        localStorage.removeItem(CAMPS_KEY);
        renderCamps();
        alert('削除しました');
      });

      // init
      populateInfo();
      loadCamps();
      renderCamps();

      // storage sync
      window.addEventListener('storage', (e)=>{
        if(e.key === CAMPS_KEY) { loadCamps(); renderCamps(); }
        if(e.key === INFO_KEY) populateInfo();
      });

    })();
  </script>
</body>
</html>
